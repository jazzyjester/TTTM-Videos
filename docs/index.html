<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=no">
  <title> 转专转 住 砖 砖专 - 住专 砖拽</title>
  <link rel="shortcut icon" href="https://www.tttm.co.il/favicon.ico">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: Arial, Helvetica, sans-serif;
      background: #f5f5f5;
      direction: rtl;
      padding: 0;
      margin: 0;
    }

    .header {
      background: #fff;
      border-bottom: 3px solid #0066cc;
      padding: 20px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1600px;
      margin: 0 auto;
      padding: 0 20px;
      text-align: center;
    }

    h1 {
      color: #0066cc;
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .subtitle {
      color: #666;
      font-size: 16px;
      margin-bottom: 8px;
    }

    .header-links {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 12px;
    }

    .header-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: #0066cc;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.2s;
    }

    .header-link:hover {
      background: #0052a3;
      transform: translateY(-2px);
    }

    .header-link-icon {
      font-size: 18px;
    }

    .main-container {
      max-width: 1600px;
      margin: 20px auto;
      padding: 0 20px;
      display: grid;
      grid-template-columns: 280px 1fr 280px;
      gap: 20px;
    }

    .sidebar {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      height: fit-content;
      position: sticky;
      top: 160px;
    }

    .sidebar-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #0066cc;
    }

    .list-container {
      max-height: 600px;
      overflow-y: auto;
    }

    .list-item {
      padding: 8px 12px;
      margin-bottom: 4px;
      background: #f8f9fa;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .list-item:hover {
      background: #e3f2fd;
      transform: translateX(-2px);
    }

    .list-item.active {
      background: #0066cc;
      color: white;
      font-weight: bold;
    }

    .item-count {
      font-size: 11px;
      color: #666;
      background: white;
      padding: 2px 6px;
      border-radius: 12px;
      min-width: 20px;
      text-align: center;
    }

    .list-item.active .item-count {
      color: #0066cc;
    }

    .player-club-info {
      font-size: 11px;
      color: #999;
      margin-right: 4px;
    }

    .list-item.active .player-club-info {
      color: #e3f2fd;
    }

    .date-filter-item {
      padding: 8px 12px;
      margin-bottom: 4px;
      background: #f8f9fa;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .date-filter-item:hover {
      background: #e3f2fd;
      transform: translateX(-2px);
    }

    .date-filter-item.active {
      background: #0066cc;
      color: white;
      font-weight: bold;
    }

    .date-filter-item.active .item-count {
      color: #0066cc;
    }

    .video-date-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .video-date-badge-today {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
    }

    .video-date-badge-yesterday {
      background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
      color: white;
    }

    .video-date-badge-week {
      background: linear-gradient(135deg, #ffc107 0%, #ffdb4d 100%);
      color: #333;
    }

    .video-date-badge-month {
      background: linear-gradient(135deg, #6c757d 0%, #95a5a6 100%);
      color: white;
    }

    .content-area {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .filter-section {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .filter-title {
      font-size: 16px;
      font-weight: bold;
      color: #333;
      margin-bottom: 12px;
    }

    .active-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .filter-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: #0066cc;
      color: white;
      border-radius: 16px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-tag:hover {
      background: #0052a3;
    }

    .filter-tag .remove-icon {
      font-weight: bold;
      font-size: 16px;
    }

    .clear-filters-btn {
      padding: 8px 16px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.2s;
    }

    .clear-filters-btn:hover {
      background: #c82333;
    }

    .videos-section {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .section-title {
      font-size: 22px;
      font-weight: bold;
      color: #333;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #0066cc;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #0066cc;
      font-size: 18px;
    }

    .error {
      background: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
      padding: 12px 16px;
      border-radius: 4px;
      margin-bottom: 20px;
    }

    .event-group {
      margin-bottom: 32px;
    }

    .event-header {
      background: #f8f9fa;
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .event-header:hover {
      background: #e9ecef;
    }

    .event-name {
      font-size: 18px;
      font-weight: bold;
      color: #0066cc;
    }

    .event-count {
      font-size: 14px;
      color: #666;
      background: white;
      padding: 4px 12px;
      border-radius: 12px;
    }

    .video-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .video-card {
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 16px;
      background: #fafafa;
      transition: all 0.2s;
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 16px;
    }

    .video-card:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-color: #0066cc;
    }

    .video-thumbnail {
      width: 120px;
      height: 90px;
      object-fit: cover;
      border-radius: 4px;
      background: #e0e0e0;
      transition: opacity 0.2s;
    }

    .video-thumbnail:hover {
      opacity: 0.8;
    }

    .video-card a {
      display: block;
    }

    .video-card-content {
      flex: 1;
    }

    .video-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .match-id {
      font-size: 16px;
      font-weight: bold;
      color: #0066cc;
      cursor: pointer;
      text-decoration: none;
      transition: color 0.2s;
    }

    .match-id:hover {
      color: #0052a3;
      text-decoration: underline;
    }

    .match-date {
      font-size: 12px;
      color: #999;
    }

    .match-details {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 16px;
      align-items: center;
      margin-bottom: 12px;
    }

    .player-info {
      text-align: center;
    }

    .player-name {
      font-weight: bold;
      color: #333;
      margin-bottom: 4px;
      cursor: pointer;
      transition: color 0.2s;
    }

    .player-name:hover {
      color: #0066cc;
    }

    .club-name {
      font-size: 12px;
      color: #666;
      cursor: pointer;
      transition: color 0.2s;
    }

    .club-name:hover {
      color: #0066cc;
    }

    .vs-divider {
      font-size: 14px;
      font-weight: bold;
      color: #999;
      text-align: center;
    }

    .score-display {
      font-size: 18px;
      font-weight: bold;
      color: #0066cc;
    }

    .video-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .event-tag {
      font-size: 12px;
      color: #0066cc;
      background: #e3f2fd;
      padding: 4px 10px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .event-tag:hover {
      background: #0066cc;
      color: white;
    }

    .video-link {
      display: inline-block;
      background: #0066cc;
      color: white;
      padding: 8px 20px;
      border-radius: 4px;
      text-decoration: none;
      font-size: 14px;
      font-weight: bold;
      transition: background 0.2s;
    }

    .video-link:hover {
      background: #0052a3;
    }

    .statistics-section {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .stat-card {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 6px;
      text-align: center;
    }

    .stat-number {
      font-size: 32px;
      font-weight: bold;
      color: #0066cc;
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 14px;
      color: #666;
    }

    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 72px;
      margin-bottom: 24px;
    }

    .empty-state h3 {
      font-size: 24px;
      margin-bottom: 12px;
      color: #666;
    }

    .about-section {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-top: 20px;
      text-align: center;
      max-width: 1600px;
      margin-left: auto;
      margin-right: auto;
      margin-bottom: 40px;
    }

    .about-title {
      font-size: 20px;
      font-weight: bold;
      color: #0066cc;
      margin-bottom: 16px;
    }

    .about-content {
      font-size: 15px;
      color: #555;
      line-height: 1.8;
      max-width: 800px;
      margin: 0 auto;
    }

    @media (max-width: 1200px) {
      .main-container {
        grid-template-columns: 1fr;
      }

      .sidebar {
        position: static;
        max-width: 100%;
      }

      .list-container {
        max-height: 300px;
      }
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 22px;
      }

      .match-details {
        grid-template-columns: 1fr;
        gap: 8px;
      }

      .vs-divider {
        margin: 8px 0;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .video-card {
        grid-template-columns: 1fr;
      }

      .video-thumbnail {
        width: 100%;
        height: 180px;
      }
    }
  </style>
</head>

<body dir="rtl">
  <div class="header">
    <div class="header-content">
      <h1> 转专转 住 砖 砖专 - 住专 砖拽</h1>
      <p class="subtitle"> 住专 砖注,  驻 专注 转专</p>
      <div class="header-links">
        <a href="https://www.youtube.com/@TableTennisIsrael" target="_blank" rel="noopener noreferrer" class="header-link">
          <span class="header-link-icon">讹</span>
          <span>注专抓  砖</span>
        </a>
        <a href="https://www.tttm.co.il" target="_blank" rel="noopener noreferrer" class="header-link">
          <span class="header-link-icon"></span>
          <span>转专 TTTM</span>
        </a>
      </div>
    </div>
  </div>

  <div class="main-container">
    <!-- Left Sidebar with clubs and events list -->
    <div class="sidebar">
      <div class="sidebar-title">注</div>
      <div id="clubList" class="list-container"></div>

      <div class="sidebar-title" style="margin-top: 24px;">专注</div>
      <div id="eventList" class="list-container"></div>
    </div>

    <!-- Main content area -->
    <div class="content-area">
      <!-- Filter section -->
      <div class="filter-section" id="filterSection" style="display: none;">
        <div class="filter-title">住 驻注</div>
        <div class="active-filters" id="activeFilters"></div>
        <button class="clear-filters-btn" id="clearFiltersBtn">拽  住</button>
      </div>

      <!-- Videos section -->
      <div class="videos-section">
        <div class="section-title">住专 砖拽</div>
        <div id="loadingContainer" class="loading">注 住专...</div>
        <div id="errorContainer"></div>
        <div id="videosContent"></div>
      </div>

      <!-- Statistics section -->
      <div class="statistics-section">
        <div class="section-title">住住拽</div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="totalVideos">0</div>
            <div class="stat-label">住" 住专</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalPlayers">0</div>
            <div class="stat-label">砖拽</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalEvents">0</div>
            <div class="stat-label">专注</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalClubs">0</div>
            <div class="stat-label">注</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Sidebar with player list and date filter -->
    <div class="sidebar">
      <div class="sidebar-title">砖拽</div>
      <div id="playerList" class="list-container"></div>

      <div class="sidebar-title" style="margin-top: 24px;">住 驻 转专</div>
      <div id="dateRangeList"></div>
    </div>
  </div>

  <!-- About Section -->
  <div class="about-section">
    <div class="about-title">转 转专</div>
    <div class="about-content">
      <p>转专  爪专 注专  住 砖 专 砖专,  专 砖拽.</p>
      <p> 转 爪 住专 砖 砖拽 转专转 砖转, 注拽 专 砖拽 注, 转 转 拽爪注 .</p>
      <p>转专 驻转 注专转 转 AI 转拽转, 专 砖 转 注 住 砖 砖专 .</p>
      <p style="margin-top: 16px; font-weight: bold;">
        专, <a href="https://remesnik.com" target="_blank" rel="noopener noreferrer" style="color: #0066cc; text-decoration: none;">专 专住拽</a>
      </p>
    </div>
  </div>

  <script>
    // Firebase configuration
    const FIREBASE_CONFIG = {
      projectId: "tttm-extension",
      apiKey: "AIzaSyAfJSJ8JuiVyTQKSFsBd9kITDxHJ946rXA"
    };

    // Global state
    let allVideos = [];
    let currentFilters = {
      players: new Set(),
      clubs: new Set(),
      events: new Set(),
      dateRange: null // Can be: 'today', 'yesterday', 'week', 'month', or null
    };

    // Function to escape HTML to prevent XSS attacks
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Function to extract YouTube video ID from URL
    function extractYouTubeId(url) {
      if (!url) return null;

      // Handle different YouTube URL formats
      const patterns = [
        /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
        /youtube\.com\/watch\?.*v=([^&\n?#]+)/
      ];

      for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match && match[1]) {
          return match[1];
        }
      }
      return null;
    }

    // Function to get YouTube thumbnail URL
    function getYouTubeThumbnail(url) {
      const videoId = extractYouTubeId(url);
      if (!videoId) return null;
      return `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
    }

    // Function to format date
    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('he-IL', {
        day: '2-digit',
        month: '2-digit',
        year: '2-digit'
      });
    }

    // Function to format time
    function formatTime(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleTimeString('he-IL', {
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Function to fetch all videos from Firebase
    async function fetchAllVideos() {
      try {
        const url = `https://firestore.googleapis.com/v1/projects/${FIREBASE_CONFIG.projectId}/databases/(default)/documents/videos`;

        const response = await fetch(url, {
          headers: {
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          console.error('Failed to fetch videos from Firebase');
          return [];
        }

        const data = await response.json();
        const videos = [];

        if (data.documents) {
          data.documents.forEach(doc => {
            const fields = doc.fields;
            const video = {
              id: doc.name.split('/').pop(),
              match: fields.match?.stringValue || '',
              url: fields.url?.stringValue || '',
              currentPlayer: fields.currentPlayer?.stringValue || '',
              currentPlayerClub: fields.currentPlayerClub?.stringValue || '',
              opponentPlayer: fields.opponentPlayer?.stringValue || '',
              opponentClub: fields.opponentClub?.stringValue || '',
              score: fields.score?.stringValue || '',
              event: fields.event?.stringValue || ' 专注',
              createdAt: fields.createdAt?.timestampValue || '',
              updatedAt: fields.updatedAt?.timestampValue || ''
            };
            videos.push(video);
          });
        }

        console.log('Loaded', videos.length, 'videos from Firebase');
        return videos;
      } catch (error) {
        console.error('Error fetching videos:', error);
        return [];
      }
    }

    // Function to group videos by event
    function groupVideosByEvent(videos) {
      const groups = {};
      videos.forEach(video => {
        const event = video.event || ' 专注';
        if (!groups[event]) {
          groups[event] = [];
        }
        groups[event].push(video);
      });

      // Sort videos within each group by date (newest first)
      Object.keys(groups).forEach(event => {
        groups[event].sort((a, b) => {
          const dateA = new Date(a.updatedAt || a.createdAt || 0);
          const dateB = new Date(b.updatedAt || b.createdAt || 0);
          return dateB - dateA;
        });
      });

      return groups;
    }

    // Function to extract unique players with their clubs
    function extractPlayers(videos) {
      const playerMap = new Map(); // Map of player name -> { count, clubs: Map of club -> count }

      videos.forEach(video => {
        // Process current player
        if (video.currentPlayer) {
          if (!playerMap.has(video.currentPlayer)) {
            playerMap.set(video.currentPlayer, { count: 0, clubs: new Map() });
          }
          const playerData = playerMap.get(video.currentPlayer);
          playerData.count++;

          if (video.currentPlayerClub) {
            const clubCount = playerData.clubs.get(video.currentPlayerClub) || 0;
            playerData.clubs.set(video.currentPlayerClub, clubCount + 1);
          }
        }

        // Process opponent player
        if (video.opponentPlayer) {
          if (!playerMap.has(video.opponentPlayer)) {
            playerMap.set(video.opponentPlayer, { count: 0, clubs: new Map() });
          }
          const playerData = playerMap.get(video.opponentPlayer);
          playerData.count++;

          if (video.opponentClub) {
            const clubCount = playerData.clubs.get(video.opponentClub) || 0;
            playerData.clubs.set(video.opponentClub, clubCount + 1);
          }
        }
      });

      // Convert to array and find most common club for each player
      return Array.from(playerMap.entries())
        .map(([name, data]) => {
          // Find the most common club for this player
          let mostCommonClub = '';
          let maxClubCount = 0;
          data.clubs.forEach((count, club) => {
            if (count > maxClubCount) {
              maxClubCount = count;
              mostCommonClub = club;
            }
          });

          return {
            name,
            count: data.count,
            club: mostCommonClub
          };
        })
        .sort((a, b) => b.count - a.count);
    }

    // Function to extract unique clubs
    function extractClubs(videos) {
      const clubMap = new Map();

      videos.forEach(video => {
        if (video.currentPlayerClub) {
          const count = clubMap.get(video.currentPlayerClub) || 0;
          clubMap.set(video.currentPlayerClub, count + 1);
        }
        if (video.opponentClub) {
          const count = clubMap.get(video.opponentClub) || 0;
          clubMap.set(video.opponentClub, count + 1);
        }
      });

      // Convert to array and sort by count (descending)
      return Array.from(clubMap.entries())
        .map(([name, count]) => ({ name, count }))
        .sort((a, b) => b.count - a.count);
    }

    // Function to extract unique events
    function extractEvents(videos) {
      const eventMap = new Map();

      videos.forEach(video => {
        if (video.event) {
          const count = eventMap.get(video.event) || 0;
          eventMap.set(video.event, count + 1);
        }
      });

      // Convert to array and sort by count (descending)
      return Array.from(eventMap.entries())
        .map(([name, count]) => ({ name, count }))
        .sort((a, b) => b.count - a.count);
    }

    // Function to check if a video is within a date range
    function isVideoInDateRange(video, range) {
      const videoDate = new Date(video.updatedAt || video.createdAt);
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);

      switch(range) {
        case 'today':
          return videoDate >= today;
        case 'yesterday':
          const yesterdayEnd = new Date(today);
          return videoDate >= yesterday && videoDate < yesterdayEnd;
        case 'week':
          const weekAgo = new Date(today);
          weekAgo.setDate(weekAgo.getDate() - 7);
          return videoDate >= weekAgo;
        case 'month':
          const monthAgo = new Date(today);
          monthAgo.setDate(monthAgo.getDate() - 30);
          return videoDate >= monthAgo;
        default:
          return true;
      }
    }

    // Function to count videos in date ranges
    function countVideosInDateRanges(videos) {
      const counts = {
        today: 0,
        yesterday: 0,
        week: 0,
        month: 0
      };

      videos.forEach(video => {
        if (isVideoInDateRange(video, 'today')) counts.today++;
        if (isVideoInDateRange(video, 'yesterday')) counts.yesterday++;
        if (isVideoInDateRange(video, 'week')) counts.week++;
        if (isVideoInDateRange(video, 'month')) counts.month++;
      });

      return counts;
    }

    // Function to set date filter
    function setDateFilter(range) {
      // Toggle: if clicking same filter, remove it
      if (currentFilters.dateRange === range) {
        currentFilters.dateRange = null;
      } else {
        currentFilters.dateRange = range;
      }

      updateFilterDisplay();
      renderContent();
    }

    // Function to get date badge for a video
    function getDateBadge(video) {
      const videoDate = new Date(video.updatedAt || video.createdAt);
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      const weekAgo = new Date(today);
      weekAgo.setDate(weekAgo.getDate() - 7);
      const monthAgo = new Date(today);
      monthAgo.setDate(monthAgo.getDate() - 30);

      if (videoDate >= today) {
        return { label: '', className: 'video-date-badge-today' };
      } else if (videoDate >= yesterday && videoDate < today) {
        return { label: '转', className: 'video-date-badge-yesterday' };
      } else if (videoDate >= weekAgo) {
        return { label: '砖注', className: 'video-date-badge-week' };
      } else if (videoDate >= monthAgo) {
        return { label: '砖', className: 'video-date-badge-month' };
      }
      return null;
    }

    // Function to render date range list
    function renderDateRangeList(videos) {
      const counts = countVideosInDateRanges(videos);
      const container = document.getElementById('dateRangeList');

      const dateRanges = [
        { id: 'today', label: '', count: counts.today },
        { id: 'yesterday', label: '转', count: counts.yesterday },
        { id: 'week', label: '7  专', count: counts.week },
        { id: 'month', label: '30  专', count: counts.month }
      ];

      let html = '';
      dateRanges.forEach(range => {
        const isActive = currentFilters.dateRange === range.id;
        html += `
          <div class="date-filter-item ${isActive ? 'active' : ''}" onclick="setDateFilter('${range.id}')">
            <span>${range.label}</span>
            <span class="item-count">${range.count}</span>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // Function to apply filters
    function applyFilters(videos) {
      if (currentFilters.players.size === 0 &&
          currentFilters.clubs.size === 0 &&
          currentFilters.events.size === 0 &&
          !currentFilters.dateRange) {
        return videos;
      }

      return videos.filter(video => {
        // Check player filter
        if (currentFilters.players.size > 0) {
          const hasPlayer = currentFilters.players.has(video.currentPlayer) ||
                           currentFilters.players.has(video.opponentPlayer);
          if (!hasPlayer) return false;
        }

        // Check club filter
        if (currentFilters.clubs.size > 0) {
          const hasClub = currentFilters.clubs.has(video.currentPlayerClub) ||
                         currentFilters.clubs.has(video.opponentClub);
          if (!hasClub) return false;
        }

        // Check event filter
        if (currentFilters.events.size > 0) {
          if (!currentFilters.events.has(video.event)) return false;
        }

        // Check date range filter
        if (currentFilters.dateRange) {
          if (!isVideoInDateRange(video, currentFilters.dateRange)) return false;
        }

        return true;
      });
    }

    // Function to toggle filter (add if not present, remove if present)
    function addFilter(type, value) {
      if (!value) return;

      // Toggle: if already in filter, remove it; otherwise add it
      if (currentFilters[type].has(value)) {
        currentFilters[type].delete(value);
      } else {
        currentFilters[type].add(value);
      }

      updateFilterDisplay();
      renderContent();
    }

    // Function to remove filter
    function removeFilter(type, value) {
      currentFilters[type].delete(value);
      updateFilterDisplay();
      renderContent();
    }

    // Function to clear all filters
    function clearAllFilters() {
      currentFilters.players.clear();
      currentFilters.clubs.clear();
      currentFilters.events.clear();
      currentFilters.dateRange = null;
      updateFilterDisplay();
      renderContent();
    }

    // Function to update filter display
    function updateFilterDisplay() {
      const filterSection = document.getElementById('filterSection');
      const activeFilters = document.getElementById('activeFilters');

      const hasFilters = currentFilters.players.size > 0 ||
                        currentFilters.clubs.size > 0 ||
                        currentFilters.events.size > 0 ||
                        currentFilters.dateRange !== null;

      if (!hasFilters) {
        filterSection.style.display = 'none';
        return;
      }

      filterSection.style.display = 'block';
      let html = '';

      // Date range filter
      if (currentFilters.dateRange) {
        const dateLabels = {
          'today': '',
          'yesterday': '转',
          'week': '7  专',
          'month': '30  专'
        };
        html += `
          <div class="filter-tag" onclick="setDateFilter('${currentFilters.dateRange}')">
            <span>转专: ${dateLabels[currentFilters.dateRange]}</span>
            <span class="remove-icon"></span>
          </div>
        `;
      }

      // Player filters
      currentFilters.players.forEach(player => {
        html += `
          <div class="filter-tag" onclick="removeFilter('players', '${escapeHtml(player)}')">
            <span>砖拽: ${escapeHtml(player)}</span>
            <span class="remove-icon"></span>
          </div>
        `;
      });

      // Club filters
      currentFilters.clubs.forEach(club => {
        html += `
          <div class="filter-tag" onclick="removeFilter('clubs', '${escapeHtml(club)}')">
            <span>注: ${escapeHtml(club)}</span>
            <span class="remove-icon"></span>
          </div>
        `;
      });

      // Event filters
      currentFilters.events.forEach(event => {
        html += `
          <div class="filter-tag" onclick="removeFilter('events', '${escapeHtml(event)}')">
            <span>专注: ${escapeHtml(event)}</span>
            <span class="remove-icon"></span>
          </div>
        `;
      });

      activeFilters.innerHTML = html;
    }

    // Function to render player list
    function renderPlayerList(videos) {
      const players = extractPlayers(videos);
      const container = document.getElementById('playerList');

      if (players.length === 0) {
        container.innerHTML = '<div style="color: #999; text-align: center; font-size: 12px;"> 砖拽</div>';
        return;
      }

      let html = '';
      players.forEach(player => {
        const isActive = currentFilters.players.has(player.name);
        const playerDisplay = player.club
          ? `${escapeHtml(player.name)} <span class="player-club-info">(${escapeHtml(player.club)})</span>`
          : escapeHtml(player.name);

        html += `
          <div class="list-item ${isActive ? 'active' : ''}" onclick="addFilter('players', '${escapeHtml(player.name)}')">
            <span>${playerDisplay}</span>
            <span class="item-count">${player.count}</span>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // Function to render club list
    function renderClubList(videos) {
      const clubs = extractClubs(videos);
      const container = document.getElementById('clubList');

      if (clubs.length === 0) {
        container.innerHTML = '<div style="color: #999; text-align: center; font-size: 12px;"> 注</div>';
        return;
      }

      let html = '';
      clubs.forEach(club => {
        const isActive = currentFilters.clubs.has(club.name);
        html += `
          <div class="list-item ${isActive ? 'active' : ''}" onclick="addFilter('clubs', '${escapeHtml(club.name)}')">
            <span style="word-break: break-word;">${escapeHtml(club.name)}</span>
            <span class="item-count">${club.count}</span>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // Function to render event list
    function renderEventList(videos) {
      const events = extractEvents(videos);
      const container = document.getElementById('eventList');

      if (events.length === 0) {
        container.innerHTML = '<div style="color: #999; text-align: center; font-size: 12px;"> 专注</div>';
        return;
      }

      let html = '';
      events.forEach(event => {
        const isActive = currentFilters.events.has(event.name);
        html += `
          <div class="list-item ${isActive ? 'active' : ''}" onclick="addFilter('events', '${escapeHtml(event.name)}')">
            <span style="word-break: break-word;">${escapeHtml(event.name)}</span>
            <span class="item-count">${event.count}</span>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // Function to render videos
    function renderVideos(videos) {
      const container = document.getElementById('videosContent');
      const loadingContainer = document.getElementById('loadingContainer');

      loadingContainer.style.display = 'none';

      if (videos.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon"></div>
            <h3> 住专</h3>
            <p> 爪 住专 转 转 住</p>
          </div>
        `;
        return;
      }

      const groupedVideos = groupVideosByEvent(videos);
      let html = '';

      Object.keys(groupedVideos).sort().forEach(eventName => {
        const eventVideos = groupedVideos[eventName];
        html += `
          <div class="event-group">
            <div class="event-header">
              <div class="event-name">${escapeHtml(eventName)}</div>
              <div class="event-count">${eventVideos.length} 住专</div>
            </div>
            <div class="video-list">
        `;

        eventVideos.forEach(video => {
          const thumbnail = getYouTubeThumbnail(video.url);
          const matchUrl = `https://www.tttm.co.il/m/${escapeHtml(video.match)}/`;
          const dateBadge = getDateBadge(video);

          html += `
            <div class="video-card">
              ${thumbnail ? `<a href="${escapeHtml(video.url)}" target="_blank" rel="noopener noreferrer"><img src="${thumbnail}" alt="Video thumbnail" class="video-thumbnail" onerror="this.style.display='none'"></a>` : ''}
              <div class="video-card-content">
                <div class="video-header">
                  <a href="${matchUrl}" target="_blank" rel="noopener noreferrer" class="match-id">砖拽 #${escapeHtml(video.match)}</a>
                  ${dateBadge ? `<span class="video-date-badge ${dateBadge.className}">${dateBadge.label}</span>` : ''}
                </div>
                <div class="match-details">
                  <div class="player-info">
                    ${video.currentPlayer ? `<div class="player-name" onclick="addFilter('players', '${escapeHtml(video.currentPlayer)}')">${escapeHtml(video.currentPlayer)}</div>` : ''}
                    ${video.currentPlayerClub ? `<div class="club-name" onclick="addFilter('clubs', '${escapeHtml(video.currentPlayerClub)}')">${escapeHtml(video.currentPlayerClub)}</div>` : ''}
                  </div>
                  <div class="vs-divider">
                    ${video.score ? `<div class="score-display">${escapeHtml(video.score)}</div>` : '<div>VS</div>'}
                  </div>
                  <div class="player-info">
                    ${video.opponentPlayer ? `<div class="player-name" onclick="addFilter('players', '${escapeHtml(video.opponentPlayer)}')">${escapeHtml(video.opponentPlayer)}</div>` : ''}
                    ${video.opponentClub ? `<div class="club-name" onclick="addFilter('clubs', '${escapeHtml(video.opponentClub)}')">${escapeHtml(video.opponentClub)}</div>` : ''}
                  </div>
                </div>
                <div class="video-footer">
                  <div class="event-tag" onclick="addFilter('events', '${escapeHtml(video.event)}')">${escapeHtml(video.event)}</div>
                  <a href="${escapeHtml(video.url)}" target="_blank" rel="noopener noreferrer" class="video-link">讹 爪驻 住专</a>
                </div>
              </div>
            </div>
          `;
        });

        html += `
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // Function to calculate and display statistics
    function updateStatistics(videos) {
      document.getElementById('totalVideos').textContent = videos.length;

      const players = new Set();
      const clubs = new Set();
      const events = new Set();

      videos.forEach(video => {
        if (video.currentPlayer) players.add(video.currentPlayer);
        if (video.opponentPlayer) players.add(video.opponentPlayer);
        if (video.currentPlayerClub) clubs.add(video.currentPlayerClub);
        if (video.opponentClub) clubs.add(video.opponentClub);
        if (video.event) events.add(video.event);
      });

      document.getElementById('totalPlayers').textContent = players.size;
      document.getElementById('totalEvents').textContent = events.size;
      document.getElementById('totalClubs').textContent = clubs.size;
    }

    // Function to render all content
    function renderContent() {
      const filteredVideos = applyFilters(allVideos);
      renderVideos(filteredVideos);
      updateStatistics(filteredVideos);
      // Re-render sidebars to update active states
      renderPlayerList(allVideos);
      renderClubList(allVideos);
      renderEventList(allVideos);
      renderDateRangeList(allVideos);
    }

    // Function to show error
    function showError(message) {
      const container = document.getElementById('errorContainer');
      container.innerHTML = `<div class="error">${escapeHtml(message)}</div>`;
      document.getElementById('loadingContainer').style.display = 'none';
    }

    // Load videos on page load
    async function loadPage() {
      try {
        allVideos = await fetchAllVideos();
        renderPlayerList(allVideos);
        renderClubList(allVideos);
        renderEventList(allVideos);
        renderDateRangeList(allVideos);
        renderContent();
      } catch (error) {
        console.error('Error loading page:', error);
        showError('砖 注转 住专.  住 砖 专 转专.');
      }
    }

    // Clear filters button
    document.getElementById('clearFiltersBtn').addEventListener('click', clearAllFilters);

    // Initialize page
    document.addEventListener('DOMContentLoaded', loadPage);
  </script>
</body>
</html>
